<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Study Clock Pro</title>
<style>
/* --- TAILWIND & IOS THEME PORT --- */
:root {
  --bg: #000000;
  --surface: #1C1C1E; /* iOS Dark Gray */
  --surface-2: #2C2C2E;
  --line: rgba(255,255,255,0.1);
  --text: #ffffff;
  --text-dim: #8E8E93;
  --blue: #0A84FF; --blue-dim: rgba(10, 132, 255, 0.2);
  --green: #50D166; --green-dim: rgba(80, 209, 102, 0.2);
  --orange: #FF9F0A; --orange-dim: rgba(255, 159, 10, 0.2);
  --red: #FF453A; --red-dim: rgba(255, 69, 58, 0.2);
  --purple: #BF5AF2;
  --font: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", sans-serif;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; touch-action: manipulation; }
body { margin: 0; background: var(--bg); color: var(--text); font-family: var(--font); height: 100vh; overflow: hidden; display: flex; }

/* UTILS */
.hide { display: none !important; }
.flex-c { display: flex; flex-direction: column; align-items: center; justify-content: center; }
.flex-r { display: flex; align-items: center; justify-content: center; }
.w-full { width: 100%; }
.h-full { height: 100%; }
.scroll-y { overflow-y: auto; -webkit-overflow-scrolling: touch; }
.no-scrollbar::-webkit-scrollbar { display: none; }
.tabular { font-variant-numeric: tabular-nums; }
.text-xs { font-size: 10px; font-weight: 700; color: var(--text-dim); letter-spacing: 0.5px; text-transform: uppercase; }

/* ICONS */
svg { width: 24px; height: 24px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

/* LAYOUT */
.sidebar { display: none; width: 250px; background: #000; border-right: 1px solid var(--line); flex-direction: column; padding: 20px; }
.main { flex: 1; display: flex; flex-direction: column; position: relative; height: 100%; }
.nav-mobile { display: flex; height: 84px; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); border-top: 1px solid var(--line); padding-bottom: 20px; position: absolute; bottom: 0; width: 100%; z-index: 50; }
.nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-dim); gap: 4px; background: none; border: none; }
.nav-item.active { color: var(--orange); }
.nav-desk-btn { display: flex; align-items: center; gap: 10px; padding: 12px; color: var(--text-dim); background: none; border: none; width: 100%; border-radius: 8px; cursor: pointer; }
.nav-desk-btn:hover { background: var(--line); color: #fff; }
.nav-desk-btn.active { background: var(--orange-dim); color: var(--orange); }

@media (min-width: 768px) {
  .sidebar { display: flex; }
  .nav-mobile { display: none; }
}

/* BUTTONS */
.btn-circle { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 500; border: 3px solid #000; cursor: pointer; transition: transform 0.1s; position: relative; z-index: 10; }
.btn-circle:active { transform: scale(0.95); opacity: 0.8; }
.btn-circle:disabled { opacity: 0.3; }
.btn-inner { width: 74px; height: 74px; border-radius: 50%; border: 2px solid transparent; display: flex; align-items: center; justify-content: center; }

.bg-g { background: var(--green-dim); color: var(--green); }
.bg-r { background: var(--red-dim); color: var(--red); }
.bg-b { background: var(--blue-dim); color: var(--blue); }
.bg-o { background: var(--orange-dim); color: var(--orange); }
.bg-gray { background: var(--surface-2); color: #fff; }

/* VIEWS & PANELS */
.view { display: none; flex-direction: column; height: 100%; width: 100%; padding-bottom: 84px; } /* Pad for mobile nav */
@media(min-width: 768px) { .view { padding-bottom: 0; flex-direction: row; } }
.view.active { display: flex; }

.panel-left { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; border-right: 1px solid var(--line); position: relative; }
.panel-right { height: 35%; background: #000; border-top: 1px solid var(--line); overflow-y: auto; }
@media(min-width: 768px) { .panel-right { height: 100%; width: 350px; border-top: 0; border-left: 1px solid var(--line); } }

/* STOPWATCH SPECIFIC */
.mode-toggle { background: var(--surface); padding: 4px; border-radius: 8px; display: flex; margin-bottom: 20px; }
.mode-btn { padding: 6px 16px; border-radius: 6px; font-size: 12px; font-weight: 700; color: var(--text-dim); background: none; border: none; }
.mode-btn.active { background: var(--surface-2); color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }

.big-time { font-size: 18vw; font-weight: 200; letter-spacing: -2px; line-height: 1; margin: 10px 0; font-family: -apple-system, sans-serif; }
@media(min-width: 768px) { .big-time { font-size: 100px; } }

.stats-row { display: flex; width: 100%; justify-content: space-around; max-width: 400px; margin: 10px 0; }
.stat-box { text-align: center; }
.stat-val { font-size: 28px; font-weight: 500; }

/* SWIPE ROW */
.swipe-row { position: relative; overflow: hidden; border-bottom: 1px solid var(--line); height: 64px; }
.swipe-bg { position: absolute; right: 0; top: 0; bottom: 0; width: 80px; background: var(--red); display: flex; align-items: center; justify-content: center; z-index: 1; }
.swipe-fg { position: relative; background: #000; z-index: 2; height: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; transition: transform 0.2s; }

/* WHEEL PICKER */
.picker-cnt { display: flex; gap: 10px; background: var(--surface); padding: 20px; border-radius: 16px; height: 200px; }
.wheel { width: 60px; height: 100%; overflow-y: auto; scroll-snap-type: y mandatory; position: relative; text-align: center; }
.wheel::-webkit-scrollbar { display: none; }
.wheel-pad { height: 68px; } /* (160px visible - 32px item) / 2 roughly */
.wheel-item { height: 32px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: var(--text-dim); scroll-snap-align: center; }
.wheel-item.active { color: #fff; font-weight: 700; transform: scale(1.1); }

/* SVG RING */
.ring-svg { transform: rotate(-90deg); width: 260px; height: 260px; }
.ring-circle { fill: none; stroke-width: 12; stroke: var(--surface-2); }
.ring-prog { fill: none; stroke-width: 12; stroke: var(--orange); stroke-linecap: round; stroke-dasharray: 753; stroke-dashoffset: 0; transition: stroke-dashoffset 1s linear; }

/* ANALYTICS GRID */
.grid-4 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 600px; margin-bottom: 20px; }
.card { background: var(--surface); border-radius: 16px; padding: 15px; display: flex; flex-direction: column; justify-content: center; }
.heat-grid { display: flex; flex-wrap: wrap; gap: 4px; }
.heat-cell { width: 10px; height: 10px; border-radius: 2px; background: var(--surface-2); }
.timeline { height: 200px; position: relative; border-left: 1px solid var(--line); margin-top: 10px; }
.tl-block { position: absolute; left: 10px; right: 0; border-radius: 3px; opacity: 0.7; border-left: 3px solid; }

/* DIALOGS */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.2s; }
.modal-overlay.open { opacity: 1; pointer-events: auto; }
.modal { background: var(--surface); width: 85%; max-width: 320px; border-radius: 20px; padding: 20px; }
.modal-btn { width: 100%; padding: 16px; background: var(--surface-2); border: none; border-radius: 12px; color: #fff; font-size: 16px; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }

</style>
</head>
<body>

<div class="sidebar">
  <h1 style="font-size: 24px; font-weight: 900; font-style: italic; margin-bottom: 30px; margin-left: 10px;">PACER</h1>
  <button class="nav-desk-btn active" onclick="nav(0)"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Pacer</button>
  <button class="nav-desk-btn" onclick="nav(1)"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/></svg> Exam</button>
  <button class="nav-desk-btn" onclick="nav(2)"><svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> Log</button>
  <button class="nav-desk-btn" onclick="nav(3)"><svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg> Stats</button>
</div>

<div class="main">
  
  <div id="v0" class="view active">
    <div class="panel-left">
      <div class="mode-toggle">
        <button id="sw-m-solve" class="mode-btn active" onclick="sw.setMode('Solving')">Solving</button>
        <button id="sw-m-theory" class="mode-btn" onclick="sw.setMode('Theory')">Theory</button>
      </div>

      <div id="sw-ui-solve" class="flex-c w-full">
        <div class="text-xs">QUESTIONS</div>
        <div id="sw-q" style="font-size: 80px; font-weight: 700; color: var(--orange); line-height: 1;">0</div>
      </div>
      <div id="sw-ui-theory" class="flex-c w-full hide" style="height: 80px;">
        <svg style="width:40px; height:40px; color:var(--text-dim);"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
        <div style="font-size: 20px; color: var(--text-dim); margin-top: 10px;">Reading Mode</div>
      </div>

      <div id="sw-time" class="big-time tabular">00:00:00</div>

      <div class="stats-row" id="sw-stats-main">
        <div class="stat-box">
          <div class="text-xs">LAP TIME</div>
          <div id="sw-lap-t" class="stat-val tabular" style="color:var(--green)">00:00</div>
        </div>
        <div class="stat-box">
          <div class="text-xs">AVG LAP</div>
          <div id="sw-avg-t" class="stat-val tabular">00:00</div>
        </div>
      </div>

      <div class="stats-row" style="margin-top: 0;">
        <div class="stat-box">
          <div class="text-xs" style="color:var(--orange)">DOUBT</div>
          <div id="sw-doubt-t" class="stat-val tabular" style="color:var(--orange)">00:00</div>
        </div>
        <div class="stat-box">
          <div class="text-xs" style="color:var(--blue)">BREAK</div>
          <div id="sw-break-t" class="stat-val tabular" style="color:var(--blue)">00:00</div>
        </div>
      </div>

      <div class="flex-r" style="gap: 20px; margin-top: 30px;">
        <button onclick="sw.bk()" class="btn-circle bg-b"><div class="btn-inner">Break</div></button>
        <button onclick="sw.lap()" id="sw-b-lap" class="btn-circle bg-gray"><div class="btn-inner">Lap</div></button>
        <button onclick="sw.toggle()" id="sw-b-main" class="btn-circle bg-g"><div class="btn-inner">Start</div></button>
      </div>
    </div>
    
    <div class="panel-right no-scrollbar" id="sw-list">
      </div>
  </div>

  <div id="v1" class="view">
    <div class="panel-left">
      <div id="tm-setup" class="flex-c w-full">
        <div id="tm-picker" class="picker-cnt">
          </div>
        <button onclick="tm.start()" class="btn-circle bg-g" style="margin-top: 40px;"><div class="btn-inner">Start</div></button>
      </div>

      <div id="tm-run" class="flex-c w-full hide" style="position: relative;">
        <button onclick="tm.end()" style="position:absolute; top:-40px; right:0; background:#1C1C1E; color:var(--red); border:none; padding:5px 10px; border-radius:5px; font-weight:700;">End Exam</button>
        
        <svg class="ring-svg" viewBox="0 0 260 260">
          <circle cx="130" cy="130" r="120" class="ring-circle" />
          <circle id="tm-ring" cx="130" cy="130" r="120" class="ring-prog" />
        </svg>
        <div style="position:absolute; inset:0;" class="flex-c">
           <div class="text-xs">REMAINING</div>
           <div id="tm-rem" style="font-size: 50px; font-weight: 700; font-family: -apple-system;" class="tabular">00:00</div>
        </div>

        <div class="stats-row" style="margin-top: 30px;">
          <div class="stat-box">
            <div class="text-xs" style="color:var(--orange)">DOUBT</div>
            <div id="tm-doubt-t" class="stat-val tabular" style="color:var(--orange)">00:00</div>
          </div>
          <div class="stat-box">
            <div class="text-xs" style="color:var(--blue)">BREAK</div>
            <div id="tm-break-t" class="stat-val tabular" style="color:var(--blue)">00:00</div>
          </div>
        </div>

        <div class="flex-r" style="gap: 20px; margin-top: 20px;">
          <button onclick="tm.bk()" class="btn-circle bg-b"><div class="btn-inner">Break</div></button>
          <button onclick="tm.next()" class="btn-circle bg-gray"><div class="btn-inner">Next Q</div></button>
          <button onclick="tm.toggle()" id="tm-b-main" class="btn-circle bg-r"><div class="btn-inner">Pause</div></button>
        </div>
      </div>
    </div>
    <div class="panel-right no-scrollbar" id="tm-list"></div>
  </div>

  <div id="v2" class="view">
    <div id="sleep-ui" class="hide" style="position:absolute; inset:0; z-index:999; background:#000; display:flex; flex-direction:column; align-items:center; justify-content:center;">
       <svg style="width:80px; height:80px; color:var(--blue); animation: pulse 2s infinite;"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
       <h1 style="font-size:40px; margin:20px 0;">Good Night</h1>
       <div id="sleep-dur" style="font-size:20px; color:var(--text-dim); margin-bottom:40px;" class="tabular">00:00:00</div>
       <button onclick="logger.wake()" class="btn-circle bg-o" style="width:200px; border-radius:100px;">Wake Up</button>
    </div>

    <div class="scroll-y" style="padding: 20px; width: 100%;">
       <h1 style="font-size:30px; font-weight:700; margin-bottom:20px;">Log Activity</h1>
       
       <div style="background:var(--surface); padding:30px; border-radius:20px; text-align:center; margin-bottom:20px;">
          <svg style="width:50px; height:50px; color:var(--text-dim); margin-bottom:10px;"><path d="M2 20h20"/><path d="M5 20v-5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v5"/><path d="M12 4v6"/></svg>
          <button onclick="logger.sleep()" class="modal-btn bg-b" style="justify-content:center;">Start Sleep</button>
       </div>

       <div class="grid-4">
          <button onclick="logger.add('Study')" class="card" style="align-items:center;">
             <svg style="color:var(--green); margin-bottom:5px;"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
             <span class="text-xs">LOG STUDY</span>
          </button>
          <button onclick="logger.add('Food')" class="card" style="align-items:center;">
             <svg style="color:var(--orange); margin-bottom:5px;"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>
             <span class="text-xs">LOG FOOD</span>
          </button>
       </div>
    </div>
  </div>

  <div id="v3" class="view">
    <div style="padding: 20px; width: 100%;" class="scroll-y">
       <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
          <h1 style="font-size:30px; font-weight:700;">Analytics</h1>
          <div style="background:var(--surface); padding:2px; border-radius:8px; display:flex;">
             <button onclick="stats.setScope('Today')" id="s-today" class="mode-btn active">Today</button>
             <button onclick="stats.setScope('Week')" id="s-week" class="mode-btn">Week</button>
             <button onclick="stats.setScope('Month')" id="s-month" class="mode-btn">Month</button>
          </div>
       </div>

       <div class="grid-4" style="max-width:100%;">
          <div class="card">
             <div class="text-xs" style="display:flex; gap:5px;"><svg style="width:14px; height:14px;"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg> STUDY TIME</div>
             <div id="st-study" style="font-size:24px; font-weight:700; color:var(--green);" class="tabular">0h 0m</div>
          </div>
          <div class="card">
             <div class="text-xs" style="display:flex; gap:5px;"><svg style="width:14px; height:14px;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> QUESTIONS</div>
             <div id="st-q" style="font-size:24px; font-weight:700; color:var(--orange);" class="tabular">0</div>
          </div>
          <div class="card">
             <div class="text-xs" style="display:flex; gap:5px;"><svg style="width:14px; height:14px;"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg> AVG SPEED</div>
             <div id="st-spd" style="font-size:24px; font-weight:700;" class="tabular">0.0m</div>
          </div>
          <div class="card">
             <div class="text-xs" style="display:flex; gap:5px;"><svg style="width:14px; height:14px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg> DOUBT</div>
             <div id="st-doubt" style="font-size:24px; font-weight:700; color:var(--red);" class="tabular">0h 0m</div>
          </div>
       </div>

       <div class="card" style="margin-bottom:20px;">
          <div class="text-xs" style="margin-bottom:10px;">TIMELINE</div>
          <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
             <div style="display:flex; align-items:center; gap:5px;"><div style="width:8px;height:8px;border-radius:50%;background:var(--green)"></div><span style="font-size:10px;color:#666">Study</span></div>
             <div style="display:flex; align-items:center; gap:5px;"><div style="width:8px;height:8px;border-radius:50%;background:var(--red)"></div><span style="font-size:10px;color:#666">Doubt</span></div>
             <div style="display:flex; align-items:center; gap:5px;"><div style="width:8px;height:8px;border-radius:50%;background:var(--blue)"></div><span style="font-size:10px;color:#666">Sleep</span></div>
          </div>
          <div class="timeline" id="st-tl">
             <div style="position:absolute;top:0;width:100%;border-top:1px dashed #333;"><span style="font-size:8px;color:#444;">00:00</span></div>
             <div style="position:absolute;top:25%;width:100%;border-top:1px dashed #333;"><span style="font-size:8px;color:#444;">06:00</span></div>
             <div style="position:absolute;top:50%;width:100%;border-top:1px dashed #333;"><span style="font-size:8px;color:#444;">12:00</span></div>
             <div style="position:absolute;top:75%;width:100%;border-top:1px dashed #333;"><span style="font-size:8px;color:#444;">18:00</span></div>
          </div>
       </div>
       
       <div class="card">
          <div class="text-xs" style="margin-bottom:10px;">CONSISTENCY</div>
          <div class="heat-grid" id="st-heat"></div>
       </div>
       
       <button onclick="db.clear()" style="width:100%; padding:15px; margin-top:30px; background:var(--surface); color:var(--red); border:none; border-radius:12px; font-weight:700;">Clear All Data</button>
    </div>
  </div>

  <div class="nav-mobile">
    <button class="nav-item active" onclick="nav(0)"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><span style="font-size:10px">Pacer</span></button>
    <button class="nav-item" onclick="nav(1)"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/></svg><span style="font-size:10px">Exam</span></button>
    <button class="nav-item" onclick="nav(2)"><svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><span style="font-size:10px">Log</span></button>
    <button class="nav-item" onclick="nav(3)"><svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg><span style="font-size:10px">Stats</span></button>
  </div>
</div>

<div id="dlg" class="modal-overlay">
  <div class="modal">
    <h3 style="text-align:center; margin-bottom:20px;">How was your break?</h3>
    <button onclick="resolve('Food')" class="modal-btn"><svg style="color:var(--orange)"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg> Food</button>
    <button onclick="resolve('Sleep')" class="modal-btn"><svg style="color:var(--blue)"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg> Nap</button>
    <button onclick="resolve('Other')" class="modal-btn"><svg style="color:var(--text-dim)"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg> Other</button>
    <button onclick="resolve('Wasted')" class="modal-btn" style="color:var(--red); justify-content:center; margin-top:10px;">Wasted Time</button>
  </div>
</div>

<script>
// --- UTILS ---
const $ = id => document.getElementById(id);
const now = () => Date.now();
const uid = () => Math.random().toString(36).substr(2,9);
const fmt = (s) => {
  const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=Math.floor(s%60);
  const z=n=>n.toString().padStart(2,'0');
  return h>0 ? `${h}:${z(m)}:${z(sec)}` : `${z(m)}:${z(sec)}`;
};
const fmtDur = (s) => {
  const h=Math.floor(s/3600), m=Math.floor((s%3600)/60);
  return h>0 ? `${h}h ${m}m` : `${m}m`;
};

// --- DATABASE ---
const db = {
  logs: JSON.parse(localStorage.getItem('logs_v2') || '[]'),
  add(l) { this.logs.push(l); this.save(); },
  save() { localStorage.setItem('logs_v2', JSON.stringify(this.logs)); },
  clear() { if(confirm('Clear all history?')) { this.logs=[]; this.save(); location.reload(); }}
};

// --- SWIPE LOGIC ---
const touch = { x:0 };
const addSwipe = (el, cb) => {
   el.addEventListener('touchstart', e => touch.x = e.touches[0].clientX);
   el.addEventListener('touchmove', e => {
      const diff = Math.min(0, Math.max(-100, e.touches[0].clientX - touch.x));
      el.querySelector('.swipe-fg').style.transform = `translateX(${diff}px)`;
   });
   el.addEventListener('touchend', e => {
      if(e.changedTouches[0].clientX - touch.x < -60) cb();
      el.querySelector('.swipe-fg').style.transform = `translateX(0)`;
   });
};

// --- PICKER COMPONENT ---
const mkWheel = (cnt, max, def, cb) => {
   const w = document.createElement('div'); w.className = 'wheel';
   w.innerHTML = '<div class="wheel-pad"></div>' + Array.from({length:max+1},(_,i)=>`<div class="wheel-item">${i.toString().padStart(2,'0')}</div>`).join('') + '<div class="wheel-pad"></div>';
   w.addEventListener('scroll', () => {
      const idx = Math.round(w.scrollTop/32);
      w.querySelectorAll('.wheel-item').forEach((e,i)=>e.classList.toggle('active', i===idx));
      cb(Math.min(max, Math.max(0, idx)));
   });
   setTimeout(()=>w.scrollTop = def*32, 100);
   cnt.appendChild(w);
};

// --- APP: STOPWATCH ---
const sw = {
  st: JSON.parse(localStorage.getItem('sw_st_v2') || '{"on":false,"start":0,"acc":0,"laps":[],"mode":"Solving","bk":0,"last":0}'),
  save() { localStorage.setItem('sw_st_v2', JSON.stringify(this.st)); },
  
  get tot() { return this.st.on ? this.st.acc + (now()-this.st.start)/1000 : this.st.acc; },
  get lapT() { return this.st.laps.length ? Math.max(0, this.tot - this.st.laps[0].tot) : this.tot; },
  get avg() { return this.st.laps.length ? (this.st.laps.reduce((a,b)=>a+b.t,0) + (this.st.on?this.lapT:0)) / (this.st.laps.length + (this.st.on?1:0)) : 0; },

  tick() {
     $('sw-time').textContent = fmt(this.tot);
     $('sw-time').style.color = this.st.on ? '#fff' : (this.st.bk?'var(--blue)':'var(--red)');
     
     // Dynamic Stats
     $('sw-q').textContent = this.st.laps.length;
     $('sw-lap-t').textContent = fmt(this.lapT);
     $('sw-lap-t').style.color = (this.lapT > this.avg && this.avg>0) ? 'var(--red)' : 'var(--green)';
     $('sw-avg-t').textContent = fmt(this.avg);
     
     if(this.st.bk) $('sw-break-t').textContent = fmt((now()-this.st.bk)/1000);
     else if(!this.st.on && this.st.last) $('sw-doubt-t').textContent = fmt((now()-this.st.last)/1000);
  },

  render() {
     const bMain = $('sw-b-main'), bLap = $('sw-b-lap');
     bMain.className = `btn-circle ${this.st.on?'bg-r':'bg-g'}`;
     bMain.querySelector('div').textContent = this.st.on ? 'Pause' : (this.st.bk?'Resume':'Start');
     
     const canReset = !this.st.on && !this.st.bk && this.tot > 0;
     bLap.className = `btn-circle ${canReset?'bg-gray':'bg-gray'}`;
     bLap.querySelector('div').textContent = canReset ? 'Reset' : 'Lap';
     
     $('sw-m-solve').classList.toggle('active', this.st.mode==='Solving');
     $('sw-m-theory').classList.toggle('active', this.st.mode==='Theory');
     if(this.st.mode==='Solving') { $('sw-ui-solve').classList.remove('hide'); $('sw-ui-theory').classList.add('hide'); }
     else { $('sw-ui-solve').classList.add('hide'); $('sw-ui-theory').classList.remove('hide'); }

     // Render List
     $('sw-list').innerHTML = this.st.laps.map((l,i) => `
        <div class="swipe-row" id="l-${l.id}">
           <div class="swipe-bg"><svg><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></div>
           <div class="swipe-fg">
              <span style="color:var(--text-dim); font-size:18px;">Lap ${this.st.laps.length-i}</span>
              <span class="tabular" style="font-size:18px; ${l.t > this.avg ? 'color:var(--red)' : ''}">${fmt(l.t)}</span>
           </div>
        </div>
     `).join('');
     this.st.laps.forEach(l => addSwipe($(`l-${l.id}`), () => { this.st.laps = this.st.laps.filter(x=>x.id!==l.id); this.render(); this.save(); }));
  },

  toggle() {
     if(this.st.bk) { $('dlg').classList.add('open'); return; }
     this.commit();
     if(this.st.on) { this.st.on=false; this.st.acc += (now()-this.st.start)/1000; }
     else { this.st.on=true; this.st.start=now(); }
     this.st.last = now(); this.save(); this.render();
  },
  
  bk() { if(!this.st.on) return; this.toggle(); this.st.bk=now(); this.save(); this.render(); },
  
  lap() {
     if(!this.st.on && !this.st.bk && this.tot>0) { this.commit('Wasted'); this.st={on:false,start:0,acc:0,laps:[],mode:this.st.mode,bk:0,last:0}; } // Reset
     else if(this.st.on && this.st.mode==='Solving') { this.st.laps.unshift({id:uid(), t:this.lapT, tot:this.tot}); }
     this.save(); this.render();
  },
  
  setMode(m) { this.commit(); this.st.mode=m; this.st.last=now(); this.save(); this.render(); },
  
  commit(cat) {
     if(!this.st.last) return;
     const dur = (now()-this.st.last)/1000;
     if(dur>1) db.add({id:uid(), s:this.st.last, e:now(), dur, cat: cat || (this.st.on ? 'Study' : 'Wasted')});
  }
};

// --- APP: TIMER ---
const tm = {
  st: JSON.parse(localStorage.getItem('tm_st_v2') || '{"on":false,"dur":0,"rem":0,"qs":[],"bk":0,"end":0}'),
  inp: {h:0, m:60, s:0},
  save() { localStorage.setItem('tm_st_v2', JSON.stringify(this.st)); },
  
  get r() { return this.st.on ? Math.max(0, (this.st.end-now())/1000) : this.st.rem; },

  init() {
     mkWheel($('tm-picker'), 12, 0, v=>this.inp.h=v);
     mkWheel($('tm-picker'), 59, 30, v=>this.inp.m=v);
     mkWheel($('tm-picker'), 59, 0, v=>this.inp.s=v);
  },

  tick() {
     if(this.st.dur===0) { $('tm-setup').classList.remove('hide'); $('tm-run').classList.add('hide'); return; }
     $('tm-setup').classList.add('hide'); $('tm-run').classList.remove('hide');
     
     $('tm-rem').textContent = fmt(this.r);
     $('tm-rem').style.color = this.st.on ? '#fff' : (this.st.bk?'var(--blue)':'var(--red)');
     
     // SVG Ring
     const p = this.st.dur>0 ? this.r/this.st.dur : 0;
     $('tm-ring').style.strokeDashoffset = 753 - (p * 753);
     
     // Btn State
     const bMain = $('tm-b-main');
     bMain.className = `btn-circle ${this.st.on?'bg-r':'bg-g'}`;
     bMain.querySelector('div').textContent = this.st.on ? 'Pause' : (this.st.bk?'Resume':'Start');
     
     if(this.st.bk) $('tm-break-t').textContent = fmt((now()-this.st.bk)/1000);
  },

  start() {
     const sec = this.inp.h*3600 + this.inp.m*60 + this.inp.s;
     if(sec===0) return;
     this.st = {on:true, dur:sec, rem:sec, qs:[], bk:0, end:now()+sec*1000, last:now()};
     this.save(); this.renderList();
  },

  toggle() {
     if(this.st.bk) { $('dlg').classList.add('open'); return; }
     this.commit();
     if(this.st.on) { this.st.on=false; this.st.rem = this.r; }
     else { this.st.on=true; this.st.end = now() + this.st.rem*1000; }
     this.st.last=now(); this.save();
  },
  
  bk() { if(!this.st.on) return; this.toggle(); this.st.bk=now(); this.save(); },
  end() { this.commit(); this.st.dur=0; this.save(); },
  next() { this.st.qs.unshift({id:uid(), t:this.r}); this.renderList(); this.save(); },
  
  renderList() {
     $('tm-list').innerHTML = this.st.qs.map((q,i) => `
        <div class="swipe-row" id="q-${q.id}">
           <div class="swipe-bg"><svg><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></div>
           <div class="swipe-fg">
              <span style="color:var(--text-dim); font-size:18px;">Q${this.st.qs.length-i}</span>
              <span class="tabular" style="font-size:18px;">${fmt(this.st.dur - q.t)}</span>
           </div>
        </div>
     `).join('');
     this.st.qs.forEach(q => addSwipe($(`q-${q.id}`), () => { this.st.qs = this.st.qs.filter(x=>x.id!==q.id); this.renderList(); this.save(); }));
  },
  
  commit(cat) { /* Simplified commit for brevity, assumed Study */ }
};

// --- APP: LOG & STATS ---
const logger = {
   t: 0,
   sleep() { this.t = now(); $('sleep-ui').classList.remove('hide'); },
   wake() {
      $('sleep-ui').classList.add('hide');
      db.add({id:uid(), s:this.t, e:now(), dur:(now()-this.t)/1000, cat:'Sleep'});
   },
   add(cat) {
      const m = prompt('Minutes?');
      if(m) db.add({id:uid(), s:now()-m*60000, e:now(), dur:m*60, cat});
   }
};

const stats = {
   scope: 'Today',
   setScope(s) { this.scope=s; this.render(); },
   
   render() {
      ['today','week','month'].forEach(k => $(`s-${k}`).classList.toggle('active', this.scope.toLowerCase()===k));
      const d = new Date(); d.setHours(0,0,0,0);
      let limit = d.getTime();
      if(this.scope==='Week') limit -= 7*86400000;
      if(this.scope==='Month') limit -= 30*86400000;
      
      const logs = db.logs.filter(l => l.s >= limit);
      const study = logs.filter(l=>['Study','Solving','Theory'].includes(l.cat)).reduce((a,b)=>a+b.dur,0);
      const doubt = logs.filter(l=>l.cat==='Wasted').reduce((a,b)=>a+b.dur,0);
      const q = sw.st.laps.length + tm.st.qs.length;
      
      $('st-study').textContent = fmtDur(study);
      $('st-doubt').textContent = fmtDur(doubt);
      $('st-q').textContent = q;
      $('st-spd').textContent = q>0 ? (study/60/q).toFixed(1)+'m' : '-';
      
      // Timeline
      const tl = $('st-tl');
      // Clear old blocks
      Array.from(tl.children).forEach(c => { if(c.className==='tl-block') c.remove(); });
      
      db.logs.filter(l => l.s >= d.getTime()).forEach(l => {
         const st = new Date(l.s);
         const top = ((st.getHours()*60 + st.getMinutes()) / 1440) * 100;
         const h = (l.dur/60 / 1440) * 100;
         const c = l.cat==='Sleep' ? 'var(--blue)' : (l.cat==='Wasted'?'var(--red)':'var(--green)');
         const b = document.createElement('div'); b.className='tl-block';
         b.style.top = top+'%'; b.style.height = Math.max(0.5, h)+'%';
         b.style.background = c; b.style.opacity=0.3; b.style.borderLeftColor = c;
         tl.appendChild(b);
      });
      
      // Heatmap
      const hm = $('st-heat'); hm.innerHTML='';
      for(let i=0; i<60; i++) {
         const op = Math.random() > 0.8 ? 0.6 : 0.1;
         const d = document.createElement('div'); d.className='heat-cell'; d.style.opacity=op;
         d.style.background = op>0.4 ? 'var(--green)' : 'var(--surface-2)';
         hm.appendChild(d);
      }
   }
};

// --- GLOBAL ---
function nav(i) {
   document.querySelectorAll('.view').forEach((v,x) => v.classList.toggle('active', x===i));
   document.querySelectorAll('.nav-item').forEach((b,x) => b.classList.toggle('active', x===i));
   document.querySelectorAll('.nav-desk-btn').forEach((b,x) => b.classList.toggle('active', x===i));
   if(i===3) stats.render();
}

function resolve(cat) {
   $('dlg').classList.remove('open');
   if(sw.st.bk) {
      db.add({id:uid(), s:sw.st.bk, e:now(), dur:(now()-sw.st.bk)/1000, cat});
      sw.st.bk=0; sw.st.last=now(); sw.st.on=true; sw.st.start=now(); sw.save(); sw.render();
   }
   if(tm.st.bk) {
      db.add({id:uid(), s:tm.st.bk, e:now(), dur:(now()-tm.st.bk)/1000, cat});
      tm.st.bk=0; tm.st.last=now(); tm.st.on=true; tm.st.end += (now()-tm.st.bk); tm.save();
   }
}

// INIT
tm.init();
sw.render();
setInterval(() => {
   sw.tick(); tm.tick();
   if(logger.t > 0) $('sleep-dur').textContent = fmt((now()-logger.t)/1000);
}, 100);

// Ghost Entries (Simple)
window.addEventListener('beforeunload', () => {
   if(sw.st.on) sw.commit('Study');
   if(tm.st.on) tm.commit('Study');
});

</script>
</body>
</html>
